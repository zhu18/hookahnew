<%
var head = {
%>
<link rel="stylesheet" type="text/css" href="/static/css/user-center-menu.css">
<link rel="stylesheet" type="text/css" href="/static/css/mybuyer.css">
<%};%>

<%
var htmlPart = {
%>
<div class="user-center">
    <div class="user-center-bd y-row">
        <div class="user-center-menu y-left">
            <%include("/layout/user-center-menu.html"){}%>
        </div>
        <div class="user-center-box y-right">
            <h3 class="center-title">购物车</h3>
            <div class="order-manage">
                <div class="order-box cart-box">
                    <% if(cartList.~size > 1){ %>
                    <table class="cart-list-title order-items">
                        <tr class="order-body">
                            <td class="checkbox"><label><input type="checkbox" class="checkall" name="checkall"> 全选</label></td>
                            <td class="img"></td>
                            <td class="name">商品信息</td>
                            <td class="price">单价(元)</td>
                            <td class="number">数量</td>
                            <td class="money">金额(元)</td>
                            <td class="operation">操作</td>
                        </tr>
                    </table>
                    <table class="order-items">
                        <!--<tr class="order-head">-->
                            <!--<td class="checkbox"><input type="checkbox" name="checkcc"></td>-->
                            <!--<td colspan="6">卖家名称：大胡子妹妹</td>-->
                        <!--</tr>-->


                        <% for(list in cartList){ %>
                        <tr class="order-body">
                            <td class="checkbox"><input type="checkbox" name="items" value="${list.recId}"></td>
                            <td class="img"><div><img src="${list.goodsImg}" alt=""></div></td>
                            <td class="name">${list.goodsName}</td>
                            <td class="price">${list.goodsPrice / 100}</td>
                            <td class="number" recId="${list.recId}">
                                <div>
                                    <span class="reduce-btn btn <% if(list.goodsNumber <= 1){ %>testcalss<% } %>" onclick="reduceFn(this)">-</span>
                                    <input type="text" class="numberInput" value="${list.goodsNumber}" onkeydown="return kkdown(this,event)" onfocus="numFocusFn(this)" >
                                    <span class="plus-btn btn" onclick="plusFn(this)">+</span>
                                </div>
                            </td>
                            <td class="money">${(list.goodsPrice * list.goodsNumber) / 100}</td>
                            <td class="operation">
                                <a href="javascript:void(0)">商品详情</a>
                                <a href="javascript:void(0)">删除</a>
                            </td>
                        </tr>
                        <% } %>




                        <!--<tr class="order-body">-->
                            <!--<td class="checkbox"><input type="checkbox"></td>-->
                            <!--<td class="img"><div><img src="../../static/img/TB1BLQsPpXXXXXNXXXXXXXXXXXX-440-330.jpg" alt=""></div></td>-->
                            <!--<td class="name">银行卡类型查询</td>-->
                            <!--<td class="price">￥8000.00</td>-->
                            <!--<td class="number">-->
                                <!--<div>-->
                                    <!--<span class="reduce-btn btn">-</span>-->
                                    <!--<input type="text" value="1">-->
                                    <!--<span class="plus-btn btn">+</span>-->
                                <!--</div>-->
                            <!--</td>-->
                            <!--<td class="money">￥8000.00</td>-->
                            <!--<td class="operation">-->
                                <!--<a href="javascript:void(0)">商品详情</a>-->
                                <!--<a href="javascript:void(0)">删除</a>-->
                            <!--</td>-->
                        <!--</tr>-->
                        <!--<tr class="order-body">-->
                            <!--<td class="checkbox"><input type="checkbox"></td>-->
                            <!--<td class="img"><div><img src="../../static/img/TB1BLQsPpXXXXXNXXXXXXXXXXXX-440-330.jpg" alt=""></div></td>-->
                            <!--<td class="name">银行卡类型查询</td>-->
                            <!--<td class="price">￥8000.00</td>-->
                            <!--<td class="number">-->
                                <!--<div>-->
                                    <!--<span class="reduce-btn btn">-</span>-->
                                    <!--<input type="text" value="1">-->
                                    <!--<span class="plus-btn btn">+</span>-->
                                <!--</div>-->
                            <!--</td>-->
                            <!--<td class="money">￥8000.00</td>-->
                            <!--<td class="operation">-->
                                <!--<a href="javascript:void(0)">商品详情</a>-->
                                <!--<a href="javascript:void(0)">评价</a>-->
                                <!--<a href="javascript:void(0)">申请售后</a>-->
                                <!--<a href="javascript:void(0)">删除</a>-->
                                <!--<a href="javascript:void(0)">再次购买</a>-->
                            <!--</td>-->
                        <!--</tr>-->
                    </table>
                    <table class="cart-list-bottom order-items">
                        <tr class="order-body">
                            <td class="checkbox"><label><input class="checkall" type="checkbox" name="checkall"> 全选</label></td>
                            <td class="img"><a href="javascript:void(0)" id="btn">删除</a></td>
                            <td class="name"></td>
                            <td class="price"></td>
                            <td class="number">已选商品 <span>0</span>件</td>
                            <td class="money">总金额：<span>￥0.00</span></td>
                            <td class="operation"><button class="buy-btn">结算</button></td>
                        </tr>
                    </table>
                    <%}else{%>
                    <div class="noDataBox">购物车没有商品 >>><a href="/">去购物</a></div>
                    <%}%>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    //全选/全不选
    $(".checkall").click(function(){
        $("[name=items]:checkbox").prop("checked",this.checked);
        $("[name=checkall]:checkbox").prop("checked",this.checked);
    });
    $("[name=items]:checkbox").click(function(){
        var flag=true;
        $("[name=items]:checkbox").each(function(){
            if(!this.checked){
                flag=false;
            }
        });
        $("[name=checkall]:checkbox").prop("checked",flag);
    })
    //删除选中
    $("#btn").click(function(){
        var str=[];
        $("[name=items]:checkbox:checked").each(function(){
            str.push($(this).val());
        });
        if(str.length >= 1){
            $.ajax({
                type: "POST",
                url: '/cart/deleteAll',
                data: {
                    ids:str
                },
                success: function (msg) {
                    if (msg.code == 1) {
                        $.alert('删除成功')
                        $("[name=items]:checkbox:checked").each(function(){
                            $(this).parents('.order-body').remove()
                        });
                        if($("[name=checkall]:checkbox").prop("checked")){
                            $('.cart-box').html('<div class="noDataBox">购物车没有商品 >>><a href="/">去购物</a></div>');
                        }
                    } else {
                        $.alert(msg.message)
                    }
                }
            });
        }else{
            $.alert('至少选择一件商品')
        }
    });
    function reduceFn(that){ //点击按钮事件
        var goodsNumber = Number($(that).siblings('input').val());
        if(goodsNumber > 1){
            goodsNumber -= 1;
            moneyFn(that, goodsNumber);
        }
        if(goodsNumber <= 1){
            $(that).addClass('testcalss')
        }
        $(that).siblings('input').val(goodsNumber)

    }
    function plusFn(that){ //点击加按钮事件
        var goodsNumber = Number($(that).siblings('input').val());
        goodsNumber += 1;
        $(that).siblings('input').val(goodsNumber)
        if(goodsNumber > 1){
            $(that).siblings('.reduce-btn').removeClass('testcalss');
        }
        moneyFn(that, goodsNumber);
    }
    function moneyFn(that, goodsNumber){ //点击加减按钮之后进行操作
        var price = Number($(that).parents('.number').siblings('.price').html());
        var money = (price * goodsNumber).toFixed(2);
        var recId = $(that).parents('.number').attr('recId');
        $(that).parents('.number').siblings('.money').html(money);
        console.log('recId:----'+recId);
        console.log('price:----'+price);
        console.log('money:----'+money);
        editAjax(recId, goodsNumber)
    }
    function editAjax(recId, goodsNumber){ //请求
        $.ajax({
            type: "POST",
            url: '/cart/edit',
            data: {
                recId: recId,
                goodsNumber:goodsNumber
            },
            success: function (msg) {
                if (msg.code == 1) {

                } else {
                    $.alert(msg.message)
                }
            }
        });
    }
    var inputVal = "";
    function numFocusFn(that){
        if($(that).val()){
            return inputVal = $(that).val();
        }
    }
    $('.numberInput').blur(function(){
        var goodsNumber = Number($(this).val());
        var recId = $(this).parents('.number').attr('recId');
        var price = Number($(this).parents('.number').siblings('.price').html());
        if($(this).val()){
            if($(this).val() % 1 == 0){
                if(inputVal != $(this).val()){
                    editAjax(recId, goodsNumber)
                    $(this).parents('.number').siblings('.money').html(price * goodsNumber);
                }else{
                    console.log('数据一样的')
                }
            }else{
                alert('请输入整数')
            }
        }else{
            alert('不能为空')
        }

    })
    function kkdown(that, e){
        var keynum = window.event ? e.keyCode : e.which;
        if(keynum == 13){
            $(that).blur()
        }

    }


</script>
<%};
include("/layout/base.html",{headSection:head,htmlSection:htmlPart}){}
%>