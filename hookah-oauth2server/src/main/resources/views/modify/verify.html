<%
var head = {
%>
<link type="text/css" rel="stylesheet" href="/static/css/verify.css">
<%};%>

<%
var htmlPart = {
%>
<div id="content">
	<div class="content-layout">
		<div class="maincenter">
			<ol class="ui-step ui-step-3" style="overflow: visible">
				<li class="ui-step-start ui-step-active">
					<div class="ui-step-line">-</div>
					<div class="ui-step-icon">
						<i class="iconfont">y</i>
						<i class="ui-step-number">1</i>
						<span class="ui-step-text">验证身份</span>
					</div>
				</li>
				<li>
					<div class="ui-step-line">-</div>
					<div class="ui-step-icon">
						<i class="iconfont">y</i>
						<i class="ui-step-number">2</i>
						<span class="ui-step-text">修改密码</span>
					</div>
				</li>

				<li class="ui-step-end">
					<div class="ui-step-line">-</div>
					<div class="ui-step-icon">
						<i class="iconfont">y</i>
						<i class="iconfont ui-step-number"></i>
						<span class="ui-step-text">完成</span>
					</div>
				</li>
			</ol>

			<div class="maincenter-box">
				<div style="width: 80%;margin:0 auto;font-size: 14px;">
					<label style="margin-right: 16px">手机验证码验证</label>账户 <em class="ft-orange">${userObj.userName}</em>
					为确认是你本人操，请完成以下验证
					<hr style="height:1px;background: #b9b9b9;border:none;margin-top: 2px">
				</div>

				<form name="validateParams" method="POST" class="ui-form" id="J_Form" novalidate="novalidate"
					  data-widget-cid="widget-0">
					<input name="_tb_token_" type="hidden" value="ARR8XbK1Xq">
					<input type="hidden" name="action" value="verify_action">
					<input type="hidden" name="event_submit_do_validate" value="notNull">
					<input type="hidden" name="_fm.v._0.t" value="8">
					<input type="hidden" name="_fm.v._0.h" value="gyLNtRokTMmG8hIgOeSzYjNoFPme1NW7fH3DMkk73ww">
					<input type="hidden" name="_fm.v._0.ty" value="8">
					<input type="hidden" name="_fm.v._0.c" value="pc">
					<div class="ui-form-item">
						<label class="ui-label">手机号码：</label>
						<input type="hidden" value="${userObj.mobile}" id="J_MobileVal" data="86" name="_fm.v._0.p">
						<div class="ui-form-text"> ${userObj.mobile}</div>
						<input type="hidden" name="_fm.v._0.a" value="86" id="areaCode">
						<!--<div class="ui-form-text">-->
							<!--<a href="javascript:void(0)"-->
							   <!--class="user-phone-switch" target="_blank" id="J_Phone_Switch">[手机不可用？点此修改]</a>-->
						<!--</div>-->
					</div>


					<div class="ui-form-item">
						<label class="ui-label">验证码：</label>

						<div class="checkcode-warp">
							<input name="captcha" id="J_Phone_Checkcode" class="ui-input ui-input-checkcode-new"
								   type="text" placeholder="请输入验证码" >
							<button id="J_GetCode" class="getcheckcode ft-orange" type="button">获取短信校验码
							</button>
							<!--<a class="getcheckcode fn-hide" id="J_GetUpmsg">获取其他验证方式</a>-->
						</div>
						<div class="ui-form-explain" style="display: none"><i class="ui-tiptext-icon iconfont"></i><span>请输入验证码</span></div>
					</div>
					<style>
						.identityError {
							color: #FF5243;
						}

						.identityError .iconfont {
							color: #FF5243;
						}
					</style>


					<!--<script type="text/javascript">-->
						<!--seajs.use(['arale/validator/0.9.5/validator', '$', 'alipay/button-count/1.1.2/button-count', 'arale/select/0.9.9/select.js'], function (Validator, jQuery, ButtonCount, Select) {-->
							<!--jQuery(function () {-->
								<!--function showExp(ele, msg, toggleClass) {-->
									<!--var item = jQuery(ele).parent(".ui-form-item");-->
									<!--var explain = item.find(".ui-form-explain");-->
									<!--if (explain.length === 0) {-->
										<!--explain = jQuery('<div class="ui-form-explain"></div>').appendTo(item);-->
									<!--}-->
									<!--var className = 'ui-form-item ' + toggleClass;-->
									<!--explain.html(msg);-->
									<!--item.attr('class', className);-->
								<!--}-->

								<!--var errorIcon = '<i class="ui-tiptext-icon iconfont">&#xF045;</i>',-->
									<!--successIcon = '<i class="ui-tiptext-icon iconfont">&#xF049;</i>';-->


								<!--//校验提示信息-->
								<!--var messages = {-->
									<!--checkCodeRequired: errorIcon + '请输入验证码'-->
								<!--};-->

								<!--Validator.addRule('limLength', function (options) {-->
									<!--var element = options.element;-->
									<!--var rule = /^[+\-]?[0-9][0-9]*(\.[0-9]+)?([eE][+\-][1-9][0-9]*)?$|^[+\-]?0?\.[0-9]+([eE][+\-][1-9][0-9]*)?$/;-->
									<!--var l = element.val().length;-->
									<!--return rule.test(element.val()) && l === Number(options.len);-->
								<!--}, errorIcon + '{{display}}是{{len}}位数字，请重新输入');-->

								<!--var validator = new Validator({-->
									<!--element: '#J_Form',-->
									<!--autoSubmit: true,-->
									<!--onItemValidate: function (element) {-->
										<!--if (jQuery(element).attr('type') === 'text') {-->
											<!--var val = jQuery(element).val();-->
											<!--val = jQuery.trim(val);-->
											<!--jQuery(element).val(val);-->
										<!--}-->
									<!--}-->
								<!--});-->


								<!--validator.addItem({-->
									<!--element: '#J_Phone_Checkcode',-->
									<!--required: true,-->
									<!--rule: "limLength{len:6}",-->
									<!--errormessageRequired: messages.checkCodeRequired,-->
									<!--display: '验证码'-->
								<!--});-->


								<!--var action;-->
								<!--var buttonCount = new ButtonCount({-->
									<!--element: jQuery('#J_GetCode'),-->
									<!--disabledClass: 'ft-gray',-->
									<!--enabledClass: 'ft-orange',-->
									<!--initialize: true,-->
									<!--hook: {-->
										<!--url: 'https://passport.alibaba.com/iv/phone/send_code.do?htoken=gyLNtRokTMmG8hIgOeSzYjNoFPme1NW7fH3DMkk73ww',-->
										<!--type: "GET",-->
										<!--dataType: "json",-->
										<!--data: {},-->
										<!--cache: false-->
									<!--},-->
									<!--count: 60,-->
									<!--countTemplate: '{{count}} 秒后，重新获取验证码'-->
								<!--}).on('success', function (data) {-->
									<!--var data = data[0];-->
									<!--if (data.content.success) {-->

										<!--if (data.content.nextAction) {-->
											<!--action = data.content.action;-->
										<!--}-->
										<!--var txt = successIcon + '验证码已发送到你的手机，15分钟内输入有效，验证码等同于密码，打死也不能告诉别人';-->
										<!--showExp(jQuery('.checkcode-warp'), txt, 'ui-tiptext-success');-->

									<!--} else {-->
										<!--buttonCount.stop();-->
										<!--showExp(jQuery('.checkcode-warp'), errorIcon + data.content.value, 'ui-form-item-error');-->
									<!--}-->
								<!--}).on('error', function (data) {-->
									<!--buttonCount.stop();-->
									<!--showExp(jQuery('.checkcode-warp'), errorIcon + '网络异常，请稍后再试', 'ui-form-item-error');-->
								<!--}).on('click', function () {-->
									<!--var ajaxHook = this.get('hook');-->

									<!--if (jQuery('#J_MobileVal').length > 0) {-->
										<!--ajaxHook.data.phone = jQuery('#J_MobileVal').val();-->
										<!--//ajaxHook.data.common = "false";-->
										<!--ajaxHook.data.type = "phone";-->
										<!--ajaxHook.data.area = jQuery('#J_MobileVal').attr("data");-->
										<!--ajaxHook.data.tag = jQuery('#J_MobileVal').attr("data");-->
										<!--jQuery('#areaCode').val(ajaxHook.data.area);-->
										<!--this.set('hook', ajaxHook);-->
										<!--showExp(jQuery('.checkcode-warp'), '正在发送验证码&hellip;', 'ui-form-item-loading');-->
										<!--return;-->
									<!--}-->
									<!--ajaxHook.data.phone = jQuery('#J_Mobile').find('option:checked').val();-->
									<!--ajaxHook.data.type = "phone";-->
									<!--ajaxHook.data.area = jQuery('#J_Mobile').find('option:checked').attr("data");-->
									<!--if (jQuery('#J_MobileTxt').length > 0 && jQuery('#J_MobileTxt').val() !== '') {-->
										<!--ajaxHook.data.area = jQuery('#country').find('option:checked').val();-->
										<!--ajaxHook.data.tag = jQuery('#country').find('option:checked').val();-->
									<!--} else {-->
										<!--ajaxHook.data.area = jQuery('#J_Mobile').find('option:checked').attr("data");-->
										<!--ajaxHook.data.tag = jQuery('#J_Mobile').find('option:checked').attr("data");-->
									<!--}-->
									<!--jQuery('#areaCode').val(ajaxHook.data.area);-->
									<!--this.set('hook', ajaxHook);-->
									<!--showExp(jQuery('.checkcode-warp'), '正在发送验证码&hellip;', 'ui-form-item-loading');-->
								<!--}).on('stop', function () {-->
									<!--jQuery('#J_GetCode').html('重新获取验证码');-->

									<!--if (action) {-->
										<!--jQuery('#J_GetCode').hide();-->
										<!--jQuery('#J_GetUpmsg').attr('href', action);-->
										<!--jQuery('#J_GetUpmsg').show();-->
										<!--jQuery('#J_GetUpmsg').parent(".ui-form-item").find(".ui-form-explain").hide();-->

									<!--}-->
								<!--});-->


								<!--if (jQuery('#J_Mobile').length > 0) {-->
									<!--var a = new Select({-->
										<!--trigger: '#J_Mobile'-->
									<!--}).render();-->


									<!--a.on('change', function (target) {-->
										<!--var code = target.attr('data-value');-->

									<!--});-->

								<!--}-->

							<!--});-->
						<!--});-->

					<!--</script>-->


					<div class="ui-form-item">
						<input type="button" id="J_goPageBtn" value=" 确定" onclick="return check()" class="ui-button ui-button-lorange">
						<a href="javascript:void(0)"
						   target="_self" class="ui-form-other">其他验证方式</a>
					</div>
				</form>

			</div>
		</div>
	</div>
</div>
<script>
	var mobile = ${userObj.mobile};
	$.getUrlParam = function (key) {
		var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
		var result = window.location.search.substr(1).match(reg);
		return result ? decodeURIComponent(result[2]) : null;
	};
	var type = $.getUrlParam('type');
	function check(){
//		window.location.href = '${host.auth}/modify/'+type;

	};
	function mobileNumIsTrue(mobile,validSms){ //验证手机验证码是否正确
		$('.loading_btns').show();
		$.ajax({
			url:'${host.auth}/sms/checkSms',
			type:'post',
			data:{
				mobile:mobile,
				validSms:validSms
			},
			success:function(data){
				if(data.code == 1){

				}else if(data.code == 0){
					$('.loading_btns').hide();
					$('#J_MobileSms').show().removeClass('msg-type-info').addClass('msg-type-error').children('.msg-cnt').html(TRLang.ERROR_IMAGECHECKCODE_INVALID).siblings('.iconfont').html('󰅕');
				}else{
					$('.loading_btns').hide();
					$.alert(data.message);
				}
			}
		});
	}
	$('#J_Phone_Checkcode').on('blur', function(){
		if(!$(this).val()){
			$(this).parents('.ui-form-item').addClass('ui-form-item-error');
			$(this).parents('.checkcode-warp').siblings('.ui-form-explain').show()
		}else{
			$(this).parents('.ui-form-item').removeClass('ui-form-item-error');
			$(this).parents('.checkcode-warp').siblings('.ui-form-explain').hide()
		}
	});
	$('#J_GetCode').click(function(){
		var that = $(this);
		$.ajax({
			url:'${host.auth}/sms/sendSms',
			type:'post',
			data:{
				mobile:mobile
			},
			success:function(data){
				if(data.code == 1){
					$.alert(data.data);
					settime(that);
				}else{
					$.alert('获取验证码失败，请重新获取');
				}
			}
		});
	});
	var countdown = 120;
	function settime(that) {
		if (countdown == 0) {
			that.removeAttr("disabled");
			that.html("重新获取验证码");
			that.removeClass('btn-disabled');
			countdown = 60;
			return;
		} else {
			that.attr("disabled", true);
			that.html("重新获取(" + countdown + ")");
			that.addClass('btn-disabled');
			countdown--;
		}
		setTimeout(function () {
				settime(that)
			}
			, 1000)
	}
</script>
<%};
include("/layout/base.html",{headSection:head,htmlSection:htmlPart}){}
%>