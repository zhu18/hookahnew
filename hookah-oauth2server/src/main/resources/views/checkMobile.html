<%
var head = {
%>
<link type="text/css" rel="stylesheet" href="/static/css/findPwd.css">

<%};%>
<%
var htmlPart = {
%>
<div class="findPwd">
    <div class="find">找回密码</div>
    <ol class="ui-step ui-step-3">
        <li class="ui-step-start ui-step-done ui-step-active">
            <div class="ui-step-line ui-step-line-active">-</div>
            <div class="ui-step-icon">
                <i class="iconfont">y</i>
                <i class="ui-step-number">1</i>
                <span class="ui-step-text"> 填写账户名 </span>
            </div>
        </li>
        <li class="ui-step-active">
            <div class="ui-step-line">-</div>
            <div class="ui-step-icon">
                <i class="iconfont">y</i>
                <i class="ui-step-number">2</i>
                <span class="ui-step-text">验证身份</span>
            </div>
        </li>
        <li class="">
            <div class="ui-step-line">-</div>
            <div class="ui-step-icon">
                <i class="iconfont">y</i>
                <i class="ui-step-number">3</i>
                <span class="ui-step-text">设置新密码</span>
            </div>
        </li>
        <li class="ui-step-end">
            <div class="ui-step-line">-</div>
            <div class="ui-step-icon">
                <i class="iconfont">y</i>
                <i class="iconfont ui-step-number"></i>
                <span class="ui-step-text"> 完成 </span>
            </div>
        </li>
    </ol>
    <div class="info">
        <label >手机号码：${mobile}
            <!--<span class="mobile"></span>-->
        </label>
        <!--<span>请输入您手机号码</span>-->
    </div>
    <div class="ui-form-item">
        <label class="ui-label">验证码：</label>
        <div class="checkcode-warp">
            <input name="captcha" id="J_Phone_Checkcode" class="ui-input ui-input-checkcode-new"
                   type="text" placeholder="请输入验证码" >
            <button id="J_GetCode" class="getcheckcode" type="button">获取短信校验码
            </button>
        </div>
        <div class="ui-form-explain" style="display: none"><i class="ui-tiptext-icon iconfont"></i><span>请输入验证码</span></div>
    </div>
    <div class="sub">提交</div>

</div>
<%};
include("layout/base.html",{headSection:head,htmlSection:htmlPart}){}
%>
<script>
    $(function(){
        $('#J_GetCode').click(function () {
            var that = $(this);
            $.ajax({
                url: '${host.auth}/sms/sendToUser',
                type: 'post',
                data: {
                    userId: '${userId}'
                },
                success: function (data) {
                    if (data.code == 1) {
                        $.alert(data.data);
                        settime(that);
                    } else {
                        $.alert('获取验证码失败，请重新获取');
                    }
                }
            });
        })

        var countdown = 120;
        function settime(that) {
            if (countdown == 0) {
                that.removeAttr("disabled");
                that.html("重新获取验证码");
                that.removeClass('btn-disabled');
                countdown = 120;
                return;
            } else {
                that.attr("disabled", true);
                that.html("重新获取(" + countdown + ")");
                that.addClass('btn-disabled');
                countdown--;
            }
            setTimeout(function () {
                    settime(that)
                }
                , 1000)
        }

        $(".sub").on("click", function () {
            $.ajax({
                url: "http://auth.hookah.app/findPwd",
                type: "post",
                data: {
                    step: 2,
                    validSms: $("#J_Phone_Checkcode").val(),
                    userId:'${userId}'
                },
                success: function (data) {
                    if (data.code == 1) {
                        window.location.href = "/findPwd?step=3&userId=" + data.data;
                    } else {
                        console.log(data.message);
                    }
                }
            })
        })

        $('#J_Phone_Checkcode').on('blur', function(){
            if(!$(this).val()){
                $(this).parents('.ui-form-item').addClass('ui-form-item-error');
                $(this).parents('.checkcode-warp').siblings('.ui-form-explain').show()
            }else{
                $(this).parents('.ui-form-item').removeClass('ui-form-item-error');
                $(this).parents('.checkcode-warp').siblings('.ui-form-explain').hide()
            }
        });
    })

</script>