<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jusfoun.hookah.core.dao.CouponMapper" >
  <resultMap id="BaseResultMap" type="com.jusfoun.hookah.core.domain.Coupon" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="coupon_sn" property="couponSn" jdbcType="VARCHAR" />
    <result column="coupon_type" property="couponType" jdbcType="TINYINT" />
    <result column="coupon_name" property="couponName" jdbcType="VARCHAR" />
    <result column="apply_platform" property="applyPlatform" jdbcType="TINYINT" />
    <result column="total_count" property="totalCount" jdbcType="INTEGER" />
    <result column="received_count" property="receivedCount" jdbcType="INTEGER" />
    <result column="used_count" property="usedCount" jdbcType="INTEGER" />
    <result column="face_value" property="faceValue" jdbcType="BIGINT" />
    <result column="limited_count" property="limitedCount" jdbcType="TINYINT" />
    <result column="apply_channel" property="applyChannel" jdbcType="TINYINT" />
    <result column="discount_value" property="discountValue" jdbcType="BIGINT" />
    <result column="expiry_start_date" property="expiryStartDate" jdbcType="TIMESTAMP" />
    <result column="expiry_end_date" property="expiryEndDate" jdbcType="TIMESTAMP" />
    <result column="valid_days" property="validDays" jdbcType="INTEGER" />
    <result column="apply_goods" property="applyGoods" jdbcType="TINYINT" />
    <result column="coupon_status" property="couponStatus" jdbcType="TINYINT" />
    <result column="add_time" property="addTime" jdbcType="TIMESTAMP" />
    <result column="activated_time" property="activatedTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="user_name" property="userName" jdbcType="VARCHAR" />
    <result column="add_user" property="addUser" jdbcType="VARCHAR" />
    <result column="activated_user" property="activatedUser" jdbcType="VARCHAR" />
    <result column="update_user" property="updateUser" jdbcType="VARCHAR" />
    <result column="is_deleted" property="isDeleted" jdbcType="TINYINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, coupon_sn, coupon_type, coupon_name, apply_platform, total_count, received_count, 
    used_count, face_value, limited_count, apply_channel, discount_value, expiry_start_date, 
    expiry_end_date, valid_days, apply_goods, coupon_status, add_time, activated_time, 
    update_time, user_name, add_user, activated_user, update_user, is_deleted
  </sql>
  <insert id="insertAndGetId" useGeneratedKeys="true" keyProperty="id" parameterType="com.jusfoun.hookah.core.domain.Coupon" >
    insert into coupon (coupon_sn, coupon_type,
    coupon_name, apply_platform, total_count,
    received_count, used_count, face_value,
    limited_count, apply_channel, discount_value,
    expiry_start_date, expiry_end_date, valid_days,
    apply_goods, coupon_status, add_time,
    activated_time, update_time, user_name,
    add_user, activated_user, update_user,
    is_deleted)
    values (#{couponSn,jdbcType=VARCHAR}, #{couponType,jdbcType=TINYINT},
    #{couponName,jdbcType=VARCHAR}, #{applyPlatform,jdbcType=TINYINT}, #{totalCount,jdbcType=INTEGER},
    #{receivedCount,jdbcType=INTEGER}, #{usedCount,jdbcType=INTEGER}, #{faceValue,jdbcType=BIGINT},
    #{limitedCount,jdbcType=TINYINT}, #{applyChannel,jdbcType=TINYINT}, #{discountValue,jdbcType=BIGINT},
    #{expiryStartDate,jdbcType=TIMESTAMP}, #{expiryEndDate,jdbcType=TIMESTAMP}, #{validDays,jdbcType=INTEGER},
    #{applyGoods,jdbcType=TINYINT}, #{couponStatus,jdbcType=TINYINT}, #{addTime,jdbcType=TIMESTAMP},
    #{activatedTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}, #{userName,jdbcType=VARCHAR},
    #{addUser,jdbcType=VARCHAR}, #{activatedUser,jdbcType=VARCHAR}, #{updateUser,jdbcType=VARCHAR},
    #{isDeleted,jdbcType=TINYINT})
  </insert>
  <select id="getUserCouponCount" resultType="com.jusfoun.hookah.core.domain.vo.UserCouponVo" parameterType="java.util.HashMap">
    SELECT cp.id AS userId,
    `user`.user_name AS userName,
    `user`.user_sn AS userSn,
    cp.c1 AS unused,
    cp.c2 AS used,
    cp.c3 AS expired
    FROM `user` RIGHT JOIN(
    SELECT uc.id,a.c1,b.c2,c.c3 FROM (SELECT DISTINCT(user_id) id from user_coupon) AS uc
    LEFT JOIN
    (SELECT user_id,user_coupon_status, COUNT(user_id) c1 FROM user_coupon WHERE user_coupon_status =0 GROUP BY user_id) AS a
    ON uc.id = a.user_id
    LEFT JOIN
    (SELECT user_id,user_coupon_status, COUNT(user_id) c2 FROM user_coupon WHERE user_coupon_status =1 GROUP BY user_id) AS b
    ON uc.id = b.user_id
    LEFT JOIN
    (SELECT user_id,user_coupon_status, COUNT(user_id) c3 FROM user_coupon WHERE user_coupon_status =2 GROUP BY user_id) AS c
    ON uc.id=c.user_id ) cp
    ON `user`.user_id = cp.id
    <where>
      <if test="userId != '' and userId != null">
        cp.id = #{userId}
      </if>
      <if test="userName != '' and userName != null">
        AND
        `user`.user_name like CONCAT('%', #{userName}, '%')
      </if>
      <if test="userSn != '' and userSn != null">
        AND
        `user`.user_sn = #{userSn}
      </if>
    </where>
  </select>
</mapper>