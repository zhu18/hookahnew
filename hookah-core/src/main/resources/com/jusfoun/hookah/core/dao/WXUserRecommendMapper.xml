<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jusfoun.hookah.core.dao.WXUserRecommendMapper" >
  <resultMap id="BaseResultMap" type="com.jusfoun.hookah.core.domain.WXUserRecommend" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="recommenderId" property="recommenderid" jdbcType="VARCHAR" />
    <result column="inviteeId" property="inviteeid" jdbcType="VARCHAR" />
    <result column="isdeal" property="isdeal" jdbcType="TINYINT" />
    <result column="isauthenticate" property="isauthenticate" jdbcType="TINYINT" />
    <result column="reward_money" property="rewardMoney" jdbcType="BIGINT" />
    <result column="add_time" property="addTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, recommenderId, inviteeId, isdeal, isauthenticate, reward_money, add_time, update_time
  </sql>

  <select id="countInviteeAndReward" resultType="java.util.HashMap" parameterType="java.lang.String">

    SELECT count(id) AS inviteeNum,SUM(reward_money) AS rewardMoney FROM wx_user_recommend WHERE  recommenderId=#{userId}
  </select>

   <sql id="sqlRecommendListByCondition">
       FROM
       wx_user_recommend wxu

       LEFT JOIN USER u ON u.user_id = wxu.recommenderId

       WHERE 1=1

       <if test="userName != '' and userName != null">
           AND (
           u.user_name like CONCAT('%', #{userName}, '%')
           OR u.user_id like CONCAT('%', #{userName}, '%')
           )
       </if>
   </sql>

  <select id="countRecommendListByCondition" resultType="java.lang.Integer" parameterType="java.util.HashMap">
       SELECT
           count(DISTINCT(wxu.recommenderId)) <include refid="sqlRecommendListByCondition"/>
  </select>
  <select id="findRecommendListByCondition" resultType="com.jusfoun.hookah.core.domain.vo.WXUserRecommendVo" parameterType="java.util.HashMap">
        SELECT
            u.user_id AS userId,
            u.user_name AS userName,
            u.user_type AS userType,
            u.mobile,
            count(wxu.id) AS inviteeNum,
            sum(wxu.reward_money) AS rewardMoney,
            (
                SELECT
                    count(wxur.id)
                FROM
                    wx_user_recommend wxur
                WHERE
                    wxur.recommenderId = wxu.recommenderId
                AND wxur.isdeal = #{isdeal}
            ) AS isdealNum
        <include refid="sqlRecommendListByCondition"/>

        GROUP BY wxu.recommenderId
        ORDER BY rewardMoney DESC
  </select>

</mapper>