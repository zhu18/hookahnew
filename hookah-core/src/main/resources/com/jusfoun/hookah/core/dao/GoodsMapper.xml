<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jusfoun.hookah.core.dao.GoodsMapper">
    <resultMap id="EsResultMap" type="com.jusfoun.hookah.core.domain.es.EsGoods">
        <id column="goods_id" jdbcType="VARCHAR" property="goodsId" />
        <result column="goods_name" jdbcType="VARCHAR" property="goodsName" />
        <result column="shop_price" jdbcType="BIGINT" property="shopPrice" />
        <result column="shop_number" jdbcType="INTEGER" property="shopNumber" />
        <result column="shop_format" jdbcType="TINYINT" property="shopFormat" />
        <result column="goods_brief" jdbcType="VARCHAR" property="goodsBrief" />
        <result column="goods_desc" jdbcType="VARCHAR" property="goodsDesc" />
        <result column="keywords" jdbcType="VARCHAR" property="keywords" />
        <result column="goods_img" jdbcType="VARCHAR" property="goodsImg" />
        <result column="cat_id" jdbcType="VARCHAR" property="catId" />
        <result column="cat_ids" jdbcType="VARCHAR" property="catIds" />
        <result column="goods_area" jdbcType="VARCHAR" property="goodsArea" />
        <result column="goods_areas" jdbcType="VARCHAR" property="goodsAreas" />
        <result column="add_time" jdbcType="TIMESTAMP" property="addTime" />
        <result column="last_update_time" jdbcType="TIMESTAMP" property="lastUpdateTime" />
        <result column="onsale_start_date" jdbcType="TIMESTAMP" property="onsaleStartDate" />
        <result column="is_discuss_price" jdbcType="TINYINT" property="isDiscussPrice" />
    </resultMap>
    <resultMap id="BaseResultMap" type="com.jusfoun.hookah.core.domain.Goods" >
        <id column="goods_id" property="goodsId" jdbcType="VARCHAR" />
        <result column="goods_sn" property="goodsSn" jdbcType="VARCHAR" />
        <result column="domain_id" property="domainId" jdbcType="VARCHAR" />
        <result column="goods_name" property="goodsName" jdbcType="VARCHAR" />
        <result column="goods_brief" property="goodsBrief" jdbcType="VARCHAR" />
        <result column="goods_desc" property="goodsDesc" jdbcType="VARCHAR" />
        <result column="keywords" property="keywords" jdbcType="VARCHAR" />
        <result column="goods_img" property="goodsImg" jdbcType="VARCHAR" />
        <result column="is_delete" property="isDelete" jdbcType="TINYINT" />
        <result column="goods_type" property="goodsType" jdbcType="TINYINT" />
        <result column="goods_number" property="goodsNumber" jdbcType="INTEGER" />
        <result column="warn_number" property="warnNumber" jdbcType="INTEGER" />
        <result column="industry" property="industry" jdbcType="VARCHAR" />
        <result column="goods_area" property="goodsArea" jdbcType="VARCHAR" />
        <result column="onsale_start_date" property="onsaleStartDate" jdbcType="TIMESTAMP" />
        <result column="onsale_end_date" property="onsaleEndDate" jdbcType="TIMESTAMP" />
        <result column="cat_id" property="catId" jdbcType="VARCHAR" />
        <result column="add_time" property="addTime" jdbcType="TIMESTAMP" />
        <result column="last_update_time" property="lastUpdateTime" jdbcType="TIMESTAMP" />
        <result column="is_real" property="isReal" jdbcType="INTEGER" />
        <result column="shop_price" property="shopPrice" jdbcType="BIGINT" />
        <result column="shop_number" property="shopNumber" jdbcType="INTEGER" />
        <result column="shop_format" property="shopFormat" jdbcType="TINYINT" />
        <result column="seller_note" property="sellerNote" jdbcType="VARCHAR" />
        <result column="add_user" property="addUser" jdbcType="VARCHAR" />
        <result column="check_status" property="checkStatus" jdbcType="TINYINT" />
        <result column="is_onsale" property="isOnsale" jdbcType="TINYINT" />
        <result column="is_book" property="isBook" jdbcType="TINYINT" />
        <result column="version" property="version" jdbcType="INTEGER" />
        <result column="shop_id" property="shopId" jdbcType="VARCHAR" />
        <result column="shop_name" property="shopName" jdbcType="VARCHAR" />
        <result column="off_reason" property="offReason" jdbcType="VARCHAR" />
        <result column="upload_url" jdbcType="VARCHAR" property="uploadUrl" />
        <result column="source_id" jdbcType="VARCHAR" property="sourceId" />
        <result column="source_type" jdbcType="VARCHAR" property="sourceType" />
        <result column="is_discuss_price" jdbcType="TINYINT" property="isDiscussPrice" />
        <result column="api_url" jdbcType="VARCHAR" property="apiUrl" />
    </resultMap>

    <resultMap id="GCResult" type="com.jusfoun.hookah.core.domain.vo.GoodsCheckedVo" >
        <id column="goods_id" property="goodsId" jdbcType="VARCHAR" />
        <result column="goods_sn" property="goodsSn" jdbcType="VARCHAR" />
        <result column="domain_id" property="domainId" jdbcType="VARCHAR" />
        <result column="goods_name" property="goodsName" jdbcType="VARCHAR" />
        <result column="goods_brief" property="goodsBrief" jdbcType="VARCHAR" />
        <result column="goods_desc" property="goodsDesc" jdbcType="VARCHAR" />
        <result column="keywords" property="keywords" jdbcType="VARCHAR" />
        <result column="goods_img" property="goodsImg" jdbcType="VARCHAR" />
        <result column="is_delete" property="isDelete" jdbcType="TINYINT" />
        <result column="goods_type" property="goodsType" jdbcType="TINYINT" />
        <result column="goods_number" property="goodsNumber" jdbcType="INTEGER" />
        <result column="warn_number" property="warnNumber" jdbcType="INTEGER" />
        <result column="industry" property="industry" jdbcType="VARCHAR" />
        <result column="goods_area" property="goodsArea" jdbcType="VARCHAR" />
        <result column="onsale_start_date" property="onsaleStartDate" jdbcType="TIMESTAMP" />
        <result column="onsale_end_date" property="onsaleEndDate" jdbcType="TIMESTAMP" />
        <result column="cat_id" property="catId" jdbcType="VARCHAR" />
        <result column="add_time" property="addTime" jdbcType="TIMESTAMP" />
        <result column="last_update_time" property="lastUpdateTime" jdbcType="TIMESTAMP" />
        <result column="is_real" property="isReal" jdbcType="INTEGER" />
        <result column="shop_price" property="shopPrice" jdbcType="BIGINT" />
        <result column="shop_number" property="shopNumber" jdbcType="INTEGER" />
        <result column="shop_format" property="shopFormat" jdbcType="TINYINT" />
        <result column="seller_note" property="sellerNote" jdbcType="VARCHAR" />
        <result column="add_user" property="addUser" jdbcType="VARCHAR" />
        <result column="check_status" property="checkStatus" jdbcType="TINYINT" />
        <result column="is_onsale" property="isOnsale" jdbcType="TINYINT" />
        <result column="is_book" property="isBook" jdbcType="TINYINT" />
        <result column="version" property="version" jdbcType="INTEGER" />
        <result column="shop_id" property="shopId" jdbcType="VARCHAR" />
        <result column="shop_name" property="shopName" jdbcType="VARCHAR" />
        <result column="off_reason" property="offReason" jdbcType="VARCHAR" />
        <result column="upload_url" jdbcType="VARCHAR" property="uploadUrl" />
        <result column="source_id" jdbcType="VARCHAR" property="sourceId" />
        <result column="source_type" jdbcType="VARCHAR" property="sourceType" />
        <result column="check_time" jdbcType="TIMESTAMP" property="checkTime" />
        <result column="check_user" jdbcType="VARCHAR" property="checkUser" />
        <result column="org_name" jdbcType="VARCHAR" property="orgName" />
    </resultMap>

    <select id="getNeedEsGoods" resultMap="EsResultMap">
        SELECT
            goods_id,
            goods_name,
            shop_price,
            shop_number,
            shop_format,
            goods_brief,
            goods_desc,
            keywords,
            goods_img,
            cat_id,
            getCategoryParentList(cat_id) cat_ids,
            goods_area goods_area,
            getRegionParentList(goods_area) goods_areas,
            add_time,
            last_update_time,
            onsale_start_date,
            is_discuss_price
        from
            goods
        where is_delete = 1
        and is_onsale = 1
        and check_status = 1
    </select>

    <select id="getNeedEsGoodsById" resultType="com.jusfoun.hookah.core.domain.es.EsGoods" parameterType="java.lang.String">
        SELECT
        goods_id,
        goods_name,
        shop_price,
        shop_number,
        shop_format,
        goods_brief,
        goods_desc,
        keywords,
        goods_img,
        cat_id,
        getCategoryParentList(cat_id) cat_ids,
        goods_area goods_area,
        getRegionParentList(goods_area) goods_areas,
        add_time,
        last_update_time,
        onsale_start_date,
        is_discuss_price
        from
        goods
        where is_delete = 1
        and is_onsale = 1
        and check_status = 1
        and goods_id = #{id}
    </select>

    <select id="getNeedGoodsById" resultType="com.jusfoun.hookah.core.domain.es.EsGoods" parameterType="java.lang.String">
        SELECT
        goods_id,
        goods_name,
        shop_price,
        shop_number,
        shop_format,
        goods_brief,
        goods_desc,
        keywords,
        goods_img,
        cat_id,
        getCategoryParentList(cat_id) cat_ids,
        goods_area goods_area,
        getRegionParentList(goods_area) goods_areas,
        add_time,
        last_update_time,
        is_discuss_price
        from
        goods
        where goods_id = #{id}
    </select>

    <sql id="waitSelect">
        WHERE
            is_delete = 1
            AND is_onsale = 1
            AND add_user = #{userId}
            <if test="isBook==1">
                AND onsale_start_date > SYSDATE()
            </if>
            <if test="isBook==0">
                AND onsale_start_date &lt;= SYSDATE()
            </if>
            <if test="goodsName!=null">
                AND goods_name like CONCAT('%', #{goodsName}, '%')
            </if>
            <if test="checkStatus!=null">
                AND check_status = #{checkStatus}
            </if>
            AND ((onsale_start_date > SYSDATE() and check_status = 1) OR check_status = 0)
        ORDER BY
            last_update_time DESC
    </sql>
    <select id="waitList" resultMap="BaseResultMap" parameterType="com.jusfoun.hookah.core.domain.Goods">
        SELECT
        goods_id,
        goods_sn,
        domain_id,
        goods_name,
        goods_brief,
        goods_desc,
        keywords,
        goods_img,
        is_delete,
        goods_type,
        goods_number,
        warn_number,
        goods_area,
        onsale_start_date,
        onsale_end_date,
        cat_id,
        add_time,
        last_update_time,
        is_real,
        shop_price,
        shop_number,
        shop_format,
        seller_note,
        add_user,
        shop_id,
        shop_name,
        off_reason,
        check_status,
        is_onsale,
        is_book,
        version,
        upload_url,
        is_discuss_price
        FROM
        goods
        <include refid="waitSelect"></include>
        limit ${rowStart},${rowEnd}
    </select>
    <select id="waitListCnt" resultType="java.lang.Integer" parameterType="com.jusfoun.hookah.core.domain.vo.GoodsVo">
        SELECT COUNT(*)
        FROM
        goods
        <include refid="waitSelect"></include>
    </select>

    <update id="updateByGidForFollowNum" parameterType="java.util.HashMap">
        update goods set
            <if test="type == 'plus'">
                follow_num = follow_num + #{changeNum}
            </if>
            <if test="type == 'sub'">
                follow_num = if(follow_num - #{changeNum} &lt; 0, 0, follow_num - #{changeNum})
            </if>
        where goods_id = #{goodsId}
    </update>

    <select id="getListForChecked" resultMap="GCResult">
        SELECT
        goods.goods_id,
        goods.goods_sn,
        goods.goods_name,
        goods.is_delete,
        goods.goods_type,
        goods.goods_area,
        goods.shop_price,
        goods.cat_id,
        goods.shop_name,
        goods.check_status,
        goods.is_onsale,
        goodsCheck.check_user,
        goodsCheck.check_time,
        org.org_name
        FROM
        (SELECT gc.*
        FROM
        goods_check gc,
        (
        SELECT
        goods_id,
        max(check_time) check_time
        FROM
        `goods_check`
        GROUP BY
        goods_id
        ) gc1
        WHERE
        gc.goods_id = gc1.goods_id
        AND gc.check_time = gc1.check_time) goodsCheck
        RIGHT JOIN goods goods ON goodsCheck.goods_id = goods.goods_id
        LEFT JOIN user u ON u.user_id = goods.add_user
        LEFT JOIN organization org ON org.org_id = u.org_id
        WHERE
        goods.check_status != 0
        AND goods.is_delete = 1 AND goods.is_local = 0
        <if test="goodsSn != '' and goodsSn != null">
            AND goods.goods_sn like '%${goodsSn}%'
        </if>
        <if test="goodsName != '' and goodsName != null">
            AND goods.goods_name like '%${goodsName}%'
        </if>
        <if test="orgName != '' and orgName != null">
            AND org.org_name like '%${orgName}%'
        </if>

    </select>

    <select id="getListByCatId" resultMap="BaseResultMap">
        SELECT
        goods.goods_id,
        goods.goods_sn,
        goods.goods_name,
        goods.is_delete,
        goods.goods_type,
        goods.goods_area,
        goods.shop_price,
        goods.cat_id,
        goods.shop_name,
        goods.check_status,
        goods.is_onsale
        FROM
        goods goods
        WHERE
        goods.is_delete = 1
        <if test="catId != '' and catId != null">
            AND goods.cat_id like '${catId}%'
        </if>

    </select>

    <update id="transferCategoryInfoByGoodsIds" >

        UPDATE goods SET cat_id = #{catId}

        WHERE   goods_id IN

        <foreach collection="ids" index="index" item="item" open="("  separator="," close=")">
            #{item}
        </foreach>

    </update>


    <select id="getNeedGoodsByCatId" resultType="com.jusfoun.hookah.core.domain.es.EsGoods" parameterType="java.lang.String">
        SELECT
        goods_id,
        goods_name,
        cat_id,
        getCategoryParentList(cat_id) cat_ids
        from
        goods
        where cat_id = #{id}
    </select>

    <insert id="insertRecord" parameterType="com.jusfoun.hookah.core.domain.Goods">
        insert into goods
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="goodsId != null" >
                goods_id,
            </if>
            <if test="goodsSn != null" >
                goods_sn,
            </if>
            <if test="domainId != null" >
                domain_id,
            </if>
            <if test="catId != null" >
                cat_id,
            </if>
            <if test="goodsName != null" >
                goods_name,
            </if>
            <if test="goodsBrief != null" >
                goods_brief,
            </if>
            <if test="keywords != null" >
                keywords,
            </if>
            <if test="goodsType != null" >
                goods_type,
            </if>
            <if test="goodsArea != null" >
                goods_area,
            </if>
            <if test="goodsImg != null" >
                goods_img,
            </if>
            <if test="trialRange != null" >
                trial_range,
            </if>
            <if test="goodsDesc != null" >
                goods_desc,
            </if>
            <if test="goodsAdvantage != null" >
                goods_advantage,
            </if>
            <if test="afterSaleService != null" >
                after_sale_service,
            </if>
            <if test="dataSample != null" >
                data_sample,
            </if>
            <if test="appCase != null" >
                app_case,
            </if>
            <if test="isDiscussPrice != null" >
                is_discuss_price,
            </if>
            <if test="isDelete != null" >
                is_delete,
            </if>
            <if test="goodsNumber != null" >
                goods_number,
            </if>
            <if test="warnNumber != null" >
                warn_number,
            </if>
            <if test="industry != null" >
                industry,
            </if>
            <if test="onsaleStartDate != null" >
                onsale_start_date,
            </if>
            <if test="onsaleEndDate != null" >
                onsale_end_date,
            </if>
            <if test="addTime != null" >
                add_time,
            </if>
            <if test="lastUpdateTime != null" >
                last_update_time,
            </if>
            <if test="isReal != null" >
                is_real,
            </if>
            <if test="shopPrice != null" >
                shop_price,
            </if>
            <if test="shopNumber != null" >
                shop_number,
            </if>
            <if test="shopFormat != null" >
                shop_format,
            </if>
            <if test="sellerNote != null" >
                seller_note,
            </if>
            <if test="addUser != null" >
                add_user,
            </if>
            <if test="checkStatus != null" >
                check_status,
            </if>
            <if test="isOnsale != null" >
                is_onsale,
            </if>
            <if test="isUpdate != null" >
                is_update,
            </if>
            <if test="version != null" >
                version,
            </if>
            <if test="shopId != null" >
                shop_id,
            </if>
            <if test="shopName != null" >
                shop_name,
            </if>
            <if test="sourceId != null" >
                source_id,
            </if>
            <if test="sourceType != null" >
                source_type,
            </if>
            <if test="offReason != null" >
                off_reason,
            </if>
            <if test="followNum != null" >
                follow_num,
            </if>
            <if test="uploadUrl != null" >
                upload_url,
            </if>
            <if test="isBook != null" >
                is_book,
            </if>
            <if test="isOffline != null" >
                is_offline,
            </if>
            <if test="isPush != null" >
                is_push,
            </if>
            <if test="ver != null" >
                ver,
            </if>
            <if test="isLocal != null" >
                is_local,
            </if>
            <if test="apiUrl != null" >
                api_url,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="goodsId != null" >
                #{goodsId,jdbcType=VARCHAR},
            </if>
            <if test="goodsSn != null" >
                #{goodsSn,jdbcType=VARCHAR},
            </if>
            <if test="domainId != null" >
                #{domainId,jdbcType=VARCHAR},
            </if>
            <if test="catId != null" >
                #{catId,jdbcType=VARCHAR},
            </if>
            <if test="goodsName != null" >
                #{goodsName,jdbcType=VARCHAR},
            </if>
            <if test="goodsBrief != null" >
                #{goodsBrief,jdbcType=VARCHAR},
            </if>
            <if test="keywords != null" >
                #{keywords,jdbcType=VARCHAR},
            </if>
            <if test="goodsType != null" >
                #{goodsType,jdbcType=VARCHAR},
            </if>
            <if test="goodsArea != null" >
                #{goodsArea,jdbcType=VARCHAR},
            </if>
            <if test="goodsImg != null" >
                #{goodsImg,jdbcType=VARCHAR},
            </if>
            <if test="trialRange != null" >
                #{trialRange,jdbcType=VARCHAR},
            </if>
            <if test="goodsDesc != null" >
                #{goodsDesc,jdbcType=VARCHAR},
            </if>
            <if test="goodsAdvantage != null" >
                #{goodsAdvantage,jdbcType=VARCHAR},
            </if>
            <if test="afterSaleService != null" >
                #{afterSaleService,jdbcType=VARCHAR},
            </if>
            <if test="dataSample != null" >
                #{dataSample,jdbcType=VARCHAR},
            </if>
            <if test="appCase != null" >
                #{appCase,jdbcType=VARCHAR},
            </if>
            <if test="isDiscussPrice != null" >
                #{isDiscussPrice,jdbcType=VARCHAR},
            </if>
            <if test="isDelete != null" >
                #{isDelete,jdbcType=SMALLINT},
            </if>
            <if test="goodsNumber != null" >
                #{goodsNumber,jdbcType=INTEGER},
            </if>
            <if test="warnNumber != null" >
                #{warnNumber,jdbcType=INTEGER},
            </if>
            <if test="industry != null" >
                #{industry,jdbcType=VARCHAR},
            </if>
            <if test="onsaleStartDate != null" >
                #{onsaleStartDate,jdbcType=TIMESTAMP},
            </if>
            <if test="onsaleEndDate != null" >
                #{onsaleEndDate,jdbcType=TIMESTAMP},
            </if>
            <if test="addTime != null" >
                #{addTime,jdbcType=TIMESTAMP},
            </if>
            <if test="lastUpdateTime != null" >
                #{lastUpdateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isReal != null" >
                #{isReal,jdbcType=INTEGER},
            </if>
            <if test="shopPrice != null" >
                #{shopPrice,jdbcType=BIGINT},
            </if>
            <if test="shopNumber != null" >
                #{shopNumber,jdbcType=INTEGER},
            </if>
            <if test="shopFormat != null" >
                #{shopFormat,jdbcType=SMALLINT},
            </if>
            <if test="sellerNote != null" >
                #{sellerNote,jdbcType=INTEGER},
            </if>
            <if test="addUser != null" >
                #{addUser,jdbcType=BIGINT},
            </if>
            <if test="checkStatus != null" >
                #{checkStatus,jdbcType=SMALLINT},
            </if>
            <if test="isOnsale != null" >
                #{isOnsale,jdbcType=SMALLINT},
            </if>
            <if test="isUpdate != null" >
                #{isUpdate,jdbcType=SMALLINT},
            </if>
            <if test="version != null" >
                #{version,jdbcType=INTEGER},
            </if>
            <if test="shopId != null" >
                #{shopId,jdbcType=VARCHAR},
            </if>
            <if test="shopName != null" >
                #{shopName,jdbcType=VARCHAR},
            </if>
            <if test="sourceId != null" >
                #{sourceId,jdbcType=VARCHAR},
            </if>
            <if test="sourceType != null" >
                #{sourceType,jdbcType=VARCHAR},
            </if>
            <if test="offReason != null" >
                #{offReason,jdbcType=VARCHAR},
            </if>
            <if test="followNum != null" >
                #{followNum,jdbcType=INTEGER},
            </if>
            <if test="uploadUrl != null" >
                #{uploadUrl,jdbcType=VARCHAR},
            </if>
            <if test="isBook != null" >
                #{isBook,jdbcType=VARCHAR},
            </if>
            <if test="isOffline != null" >
                #{isOffline,jdbcType=SMALLINT},
            </if>
            <if test="isPush != null" >
                #{isPush,jdbcType=SMALLINT},
            </if>
            <if test="ver != null" >
                #{ver,jdbcType=VARCHAR},
            </if>
            <if test="isLocal != null" >
                #{isLocal,jdbcType=SMALLINT},
            </if>
            <if test="apiUrl != null" >
                #{apiUrl,jdbcType=SMALLINT},
            </if>
        </trim>
    </insert>

    <select id="getGoodsInfoByCatIds" resultMap = "BaseResultMap">
        SELECT * FROM goods WHERE cat_id NOT IN
        <foreach collection='array' index='index' item='item' open='(' separator=',' close=')'>
            #{item}
        </foreach>
    </select>

    <update id="updateGoodsInfoByCatIds" >

        UPDATE goods SET is_onsale = 2

        WHERE   cat_id NOT IN

        <foreach collection="ids" index="index" item="item" open="("  separator="," close=")">
            #{item}
        </foreach>

    </update>

</mapper>